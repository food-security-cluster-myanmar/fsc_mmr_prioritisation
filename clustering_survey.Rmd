---
title: "Untitled"
output: html_document
date: '2022-06-14'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10)
library(tidyverse)
library(tidymodels)
library(factoextra)
library(dendextend)
library(corrplot)
library(viridis)
library(patchwork)
library(DT)
library(pander)
library(vip)
library(patchwork)
library(janitor)
library(rpart)
library(rpart.utils)
library(rattle)
library(rpart.plot)

# scaling functions 
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

`%out%` <- Negate(`%in%`)

theme_set(theme_minimal())

# pander tables all in one row
panderOptions('table.split.table', Inf)

# disabling scientific notation
options(scipen = 999)
```

## Datasets 

Housing types not relevant -- More than 3200 of the responses were apartment or condo. 

### Survey

Round 3

```{r}
survey <- read_csv("./data/survey3.csv")

set.seed(456)
```

Round 2
```{r}
survey2 <- read_csv("./data/survey.csv")
```


Comparison with Round 2
```{r}
rbind(
survey2 %>% 
  group_by(state) %>% 
  summarise(count = n()) %>% 
  mutate(state = case_when(str_detect(state, "Shan") ~ "Shan", 
                           str_detect(state, "Bago") ~ "Bago", 
                           TRUE ~ state)) %>% 
  mutate(round = 2), 

survey %>% group_by(state = adm1_name_en) %>% 
  summarise(count = n()) %>%  
  mutate(round = 3)
) %>%
  mutate(round = as.factor(round)) %>% 
  ggplot(aes(x = state, y = count, fill = round)) + 
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("goldenrod", "navyblue")) + 
  # theme(axis.text.x = element_text(angle = 60)) + 
  labs(x = "", y = "Households", 
       title = "Number of households surveyed by FAO/WFP, rounds 2 and 3") 

survey_long %>%  
  filter(str_detect(var, "shocks_|hoh_|rural|expense_food|not_improved|agri_activity|income_ms_|edu_|size|children|disability") |
           var %in% c("fs_score4", "expense_food")) %>% 
  lm_prep_long() %>% 
  mutate(fs_score4 = log(fs_score4)) %>% 
  mutate(fs_score4 = ifelse(is.infinite(fs_score4), 0, fs_score4)) %>% 
  lm(fs_score4 ~ . -1, data = .) %>% 
  plot_coef() + 
  labs(title = "Food insecurity score") 

```


```{r}
survey_debt <- survey %>% 
  left_join(tribble(
    ~hh_debt_borrow_why, ~debt_borrow_why_short, ~debt_borrow_why_text,
    1, "why_buy_food", "x67_To buy food",
    2, "why_buy nfis",  "x67_To buy non-food items",
    3, "why_accomodation",  "x67_To pay for rent or an accomodation",
    4, "why_education",  "x67_To pay school/education costs",
    5, "why_health", "x67_To cover health expenses",
    6, "why_other", "x67_To pay for durable goods",
    7, "why_other", "x67_To pay for ceremonies/social events",
    8, "why_other", "x67_To buy an apartment/house",
    9, "why_other", "x67_To pay ticket/cover travel for migration",
    10,"why_ag_input", "x67_To buy agricultural land/inputs or livestock",
    11, "why_invest_business", "x67_To invest in business",
    12, "why_other","x67_To pay back another loan",
    13, "why_other","x67_Other",
    14, "why_other", "x67_DON'T KNOW",
    15, "why_other", "x67_REFUSED"
  ), by = "hh_debt_borrow_why") %>% 
  mutate(count = ifelse(!is.na(debt_borrow_why_short), 1, 0)) %>% 
  pivot_wider(names_from = debt_borrow_why_short, values_from = count, values_fill = 0) %>%
  clean_names() %>% 
  left_join(tribble(~hh_debt_borrow_from, ~debt_borrow_from_short, ~debt_borrow_from_text,
                    1, "from_relatives", "x66_Relatives",
                    2, "from_other", "x66_Relatives living outside the country",
                    3, "from_other", "x66_Traders/shopkeepers",
                    4, "from_bank_credit", "x66_Bank/Credit institution/Government/Micro-credit project",
                    5, "from_money_lender", "x66_Money lender",
                    6, "from_other", "x66_Landlord [more than 1 month behind in rent]",
                    7, "from_other", "x66_Informal savings group",
                    8, "from_other", "x66_Employer",
                    9, "from_other", "x66_Other"), 
            by = "hh_debt_borrow_from") %>% 
  mutate(count = ifelse(!is.na(debt_borrow_from_short), 1, 0)) %>% 
  pivot_wider(names_from = debt_borrow_from_short, values_from = count, values_fill = 0) %>% 
  clean_names() %>% 
  select(matches("why_|from_"), survey_id, -matches("migration"), 
         -debt_borrow_why_text, -debt_borrow_from_text)

income_main <- tribble(~income_main, ~income_main_source, ~main_sub_groups,
        1, "ims_farmer_staple", "Farmer / Production and sale of staple crops",
        2, "ims_farmer_veg_fruit", "Farmer / Production and sale of vegetable or fruit", 
        3, "ims_farmer_cash_crops", "Farmer / Production and sale of cashcrops",
        4, "ims_fish_livestock", "Farmer / Production and sale of livestock and livestock products",
        5, "ims_fish_livestock", "Farmer / Production and sale of fish",
        6, "ims_other","main_Collection and sale of forestry or bush products", 
        7, "ims_other","main_Informal agricultural trade EXCLUDING producers", 
        8, "ims_other","main_Formal agricultural trade EXCLUDING producers", 
        9, "ims_casual_ag", "main_Daily wage on farms and other casual employment in agricultural sector", 
        10, "ims_stable_ag", "main_Stable employment in agricultural sector", 
        11, "ims_prof_self_em",  "main_Non-agricultural self-employed or liberal profession / doctor / architect / lawyer / including restaurant",
        12, "ims_casual_non_ag", "main_Off-farm daily wages and other non-agricultural casual employment", 
        13, "ims_stable_non_ag", "main_Stable employment in non-agricultural sector", 
        14, "ims_public_em", "main_Public employment", 
        15, "ims_other", "main_Income not derived from work / Charity", 
        16, "ims_other", "main_Income not derived from work / Welfare transfer / pension / humanitarian aid", 
        17, "ims_other", "main_Income not derived from work / Remittances", 
        18, "ims_other", "main_Income not derived from work / Income from other rents", 
        19, "ims_no_income", "main_No income source in the last 3 months and used exclusively savings", 
        20, "ims_no_income", "main_No income source in the last 3 months and used exclusively debt", 
        21, "ims_other", "main_REFUSED")
```

```{r}
survey %>%  
  
  
  glimpse()

survey %>% select(matches("covid")) %>% 
  select(covid_goodstransp, covid_marketclosed, covid_borderclosed, covid_stayhome, 
         covid_gatherings, covid_processclosed, covid_other) %>% 
  summarise_all(sum)

survey %>% select(matches("ims")) %>%  
  summarise_all(sum)
```

```{r}
survey %>% select(matches("ims"))

ims_prof_self_em
ims_no_income
```


### Mini
```{r}

survey_mini <- survey %>%
  mutate(
    edu_higher = ifelse(hoh_education == "edu_higher", 1, 0),
    edu_low = ifelse(hoh_education %in% c ("edu_none", "edu_primary"), 1, 0),
    edu_primary = ifelse(hoh_education == "edu_primary", 1, 0),
    edu_secondary = ifelse(hoh_education == "edu_secondary", 1, 0),
    # edu_religious = ifelse(hoh_education ==  "edu_religious", 1, 0), 
    hh_debt = case_when(hh_debt_borrow_from %in% c(1, 2) ~ 0, 
                        hh_debt_borrow_from %in% c(3, 4, 5, 6, 7, 8, 9) ~ 1, 
                        TRUE ~ 0)) %>%
  select(
    ims_farmer,
    ims_other, 
    ims_public_em, 
    ims_stable_ag, 
    ims_stable_non_ag, 
    ims_casual_ag,
    ims_casual_non_ag,
    ims_prof_self_em, 
    ims_no_income, 
    shocks_conflict,
    shocks_lostwork,  
    shocks_foodprices, 
    shocks_cantworkbusiness,
    shocks_accessmarket, 
    no_accessmarket,
    edu_higher,
    edu_secondary,
    edu_primary,
    edu_low,
    rural,
    children_0_4,
    hoh_female,
    fies_ateless, fies_fewfoods, fies_healthy, fies_hungry,
    fies_worried, fies_ranout, fies_whlday, fies_skipped,
    fcs_stap, fcs_pulse, fcs_dairy, fcs_pr,
    fcs_veg, fcs_fruit, fcs_fat, fcs_sugar, 
    fcs_borderline_poor, 
    cs_stress_hh_assets,
    cs_stress_spent_savings,
    cs_stress_credit,
    cs_stress_borrowed_money,
    cs_crisis_sold_prod_assets,
    cs_crisis_no_school,
    cs_crisis_reduced_health_exp,
    cs_crisis_childwork,
    cs_crisis_consumed_seed_stocks,
    cs_emergency_sold_house,
    cs_emergency_hh_risk,
    cs_emergency_sold_last_draught,
    cs_emergency_hh_migration, 
    hh_debt_more,
    survey_id, 
    agri_hhd, 
    hh_size, 
    no_accessmarket, 
    not_improved_drinking_water, 
    tot_income,
    income_reduced, 
    covid_goodstransp, 
    covid_marketclosed
  ) %>%
  mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) 

```



housing types are not useful for discrimination 

```{r}
survey %>%  
  count(housing_type) %>%  
  mutate(pc = n / sum(n))

```

## Coefficients

### Removal list 

```{r}
# Removal list

removal_list <- c("fcs_borderline_poor", "priority", "survey_id", 
                  "hhfcs_inv", "fies_raw_range", "csi_weighted", "weight_final")
```


### Plot_coef

```{r}

plot_coef <- function(tbl) {
  
  tbl %>%
    tidy(conf.int = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    filter(p.value <= .05) %>% 
    mutate(term = fct_reorder(term, estimate)) %>%  
    ggplot(aes(x = estimate, y = term, colour = estimate)) + 
    geom_vline(xintercept = 0, lty = 2, colour = "red") + 
    geom_point() + 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) + 
    scale_colour_viridis(option = "turbo") + 
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 8.5), 
          axis.title.x = element_text(size = 7, face = "bold"), 
          plot.title = element_text(size = 9), 
          plot.background = element_rect(colour = "white"))
}

```


```{r}
survey_mini %>%  
  count(no_market, shocks_accessmarket)
```

```{r}
survey2 %>% 
  select(hoh_female, children_0_4, hh_size, hhdisability, fs_score, 
         rural, expense_food, not_improved_sanitation, income_main_comp, 
         agri_activity, lhcsi_max, lhcsi_range, accessmarket, 
         survey_id, matches("shocks_")
         ) %>% 
  left_join(survey2 %>% 
              select(survey_id, income_source, hoh_education) %>% 
              pivot_longer(cols = -survey_id, names_to = "old_var", values_to = "var") %>% 
              mutate(value = 1) %>% 
              select(-old_var) %>% 
              pivot_wider(names_from = var, values_from = value, values_fill = 0), 
            by = "survey_id") %>%  
  mutate(score = log(fs_score), 
         score = ifelse(is.infinite(score), 0, score)) %>%
  select(-fs_score, -survey_id, -`NA`, -income_ms_fisheries, -edu_religious, -lhcsi_range) %>% 
  lm(score ~ ., data = .) %>% 
  plot_coef() + 
  labs(title = "Food Insecurity Score")


```


```{r fig.height=8}


survey_mini %>%
  left_join(survey %>% select(score = fs_score, survey_id), by = "survey_id") %>% 
  select(-survey_id, -matches("cs_|fies_|fcs_"), -tot_income) %>%
  mutate(score = log(score), 
         score = ifelse(is.infinite(score), 0, score))  %>% 
  lm(score ~ ., data = .) %>% 
  plot_coef() + 
  labs(title = "Food Insecurity Score") +

survey_mini %>%
  left_join(survey %>% select(score = hhfcs_inv, survey_id), by = "survey_id") %>% 
  select(-survey_id, -matches("cs_|fies_|fcs_"), -tot_income) %>%
  # mutate(score = log(score), 
  #        score = ifelse(is.infinite(score), 0, score))  %>% 
  lm(score ~ ., data = .) %>% 
  plot_coef() + 
  labs(title =  "Food Consumption Score", y = "") +
  
survey_mini %>% 
  left_join(survey %>% select(score = csi_weighted, survey_id), by = "survey_id") %>% 
  select(-survey_id, -matches("cs_|fies_|fcs_"), -tot_income) %>%
  # mutate(score = log(score), 
  #        score = ifelse(is.infinite(score), 0, score))  %>% 
  lm(score ~ ., data = .) %>% 
  plot_coef() + 
  labs(title = "Coping Strategies Index", y = "") + 
  
survey_mini %>% 
  left_join(survey %>% select(score = fies_raw_range, survey_id), by = "survey_id") %>% 
  select(-survey_id, -matches("cs_|fies_|fcs_"), -tot_income) %>%
  # mutate(score = log(score), 
  #        score = ifelse(is.infinite(score), 0, score))  %>% 
  lm(score ~ ., data = .) %>% 
  plot_coef() + 
  labs(title = "Food Insecurity Experience Scale", y = "") + 
  
  plot_annotation(title = "Coefficient plots -- food security indices", 
                  subtitle = "Redder colours indicate higher correlations with food insecurity", 
                  caption = "Data source: WFP-FAO survey", 
                  theme = theme(plot.caption = element_text(hjust = .5)))
  
ggsave(filename = "./misc/coefficient_plots.png", dpi = 300, height = 7, width = 11, units = "in")
  
  
```

```{r}
survey_mini %>%
  left_join(survey %>% select(score = fs_score, survey_id), by = "survey_id") %>% 
  select(-survey_id, -matches("cs_|fies_|fcs_")) %>%
  lm(score ~ ., data = .) %>%  tidy() %>%  arrange(desc(estimate))
```

```{r}

```



```{r}
survey_mini %>%
  select(-survey_id) %>% 
  lm(no_market ~ ., data = .) %>% 
  tidy(conf.int = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    mutate(term = fct_reorder(term, estimate)) %>%  
    ggplot(aes(x = estimate, y = term, colour = estimate)) + 
    geom_vline(xintercept = 0, lty = 2, colour = "red") + 
    geom_point() + 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) + 
    scale_colour_viridis(option = "turbo") + 
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 8.5), 
          axis.title.x = element_text(size = 7, face = "bold"), 
          plot.title = element_text(size = 9))

glimpse(survey_mini)
```


# Random Forest

### Recipe

```{r}

survey_rf <- survey_mini %>% 
  left_join(survey %>% select(survey_id, fs_score), by = "survey_id") %>%
  select(-matches("fcs_|fies_|cs_"), -survey_id) 

set.seed(789)

rf_split <- initial_split(survey_rf, prop = .8) 

rf_recipe <- recipe(shocks_conflict ~ ., data = survey_rf) %>% 
  step_corr(all_predictors()) %>% 
  step_center(all_predictors(), -all_outcomes()) %>% 
  step_scale(all_predictors(), -all_outcomes()) %>% 
  prep()

```

### VIP

```{r}

train <- juice(rf_recipe)
test <- juice(rf_recipe) 

rf_spec <- rand_forest(mtry = .cols()) %>% 
  set_engine("randomForest", importance = TRUE) %>% 
  set_mode("regression")

class_spec <- rand_forest(mtry = .cols()) %>% 
  set_engine("randomForest", importance = TRUE) %>% 
  set_mode("classification")

rf_fit_train <- fit(class_spec, shocks_conflict ~ ., data= train)
rf_fit_test <- fit(rf_spec, fs_score ~ ., data = train)


vip(rf_fit_test, num_features = 20L, geom = c("col")) +  
  labs(title = "Variable importance plot -- Food Insecurity")

```

### 75th Percentile

```{r}

survey %>% 
  select(fs_score, fies_raw_range, csi_weighted, hhfcs_inv) %>% 
  pivot_longer(cols = everything(), names_to = "score", values_to = "value") %>% 
  group_by(score) %>% 
  summarise_at("value", ~ quantile(.x, probs = .75)) 
```


```{r}
score_plot <- function(tbl) {
  
  tbl %>% 
    ggplot(aes(x = score)) + 
    geom_histogram(bins = 50) + 
    scale_x_log10()  
  
}

survey %>% 
  mutate(score = csi_weighted) %>% 
  score_plot() +
  geom_vline(xintercept = 0.1428571, lty = 2, colour = "darkgoldenrod2", alpha = .5, lwd = 2) + 

survey %>% 
  mutate(score = fies_raw_range) %>% 
  score_plot() +
  geom_vline(xintercept = 0.2500000, lty = 2, colour = "darkgoldenrod2", alpha = .5, lwd = 2)  
  
survey %>% 
  mutate(score = fs_score) %>% 
  score_plot() +
  geom_vline(xintercept = 0.2426743, lty = 2, colour = "darkgoldenrod2", alpha = .7, lwd = 2) + 
  
survey %>% 
  mutate(score = hhfcs_inv) %>% 
  score_plot() +
  # geom_vline(xintercept = 0.7083333, lty = 2, colour = "red", alpha = .5, lwd = 2) + 
  geom_vline(xintercept = (112 - 35) / 112, lty = 2, colour = "darkgoldenrod2", alpha = .7, lwd = 2)  
  

```



### Noaccessmarkets

```{r}
survey %>% 
  count(shocks_accessmarket, shocks_conflict)  
  lm(no_)

survey %>%
  count(access_market_why)
  select(matches("access"))
  
  
```

### FIES

```{r}
survey %>% 
  select(fies_ateless, fies_fewfoods, fies_healthy, fies_hungry, 
         fies_worried, fies_ranout, fies_whlday, fies_skipped) %>% cor() %>% corrplot()
  pivot_longer(cols = everything(), names_to = "score", values_to = "value") %>% 
  group_by(score) %>% 
  summarise_at("value", ~ sum(.x))
  
survey %>% 
  select(fies_raw_range, matches("shocks"), -shocks_none) %>% 
  cor() %>% corrplot()
```



# Preparation using tidy models 

### Complete

```{r}
# different agglomeration options
# ward definitely works the best 

survey_complete <- recipe(~., data = survey_mini) %>%
  update_role(survey_id, new_role = "ID") %>% 
  step_normalize(all_predictors()) %>% 
  prep() %>%
  bake(new_data = NULL) %>% 
  dist() %>% 
  hclust(method = "complete")

survey_complete$labels <- survey$survey_id

```

### Average

```{r}
survey_average <- recipe(~., data = survey_mini) %>%
  step_normalize(all_predictors()) %>% 
  prep() %>%
  bake(new_data = NULL) %>% 
  dist() %>% 
  hclust(method = "average")

survey_average$labels <- survey$survey_id
```


### Single

```{r}
survey_single <- recipe(~., data = survey_mini) %>%
  step_normalize(all_predictors()) %>% 
  prep() %>%
  bake(new_data = NULL) %>% 
  dist() %>% 
  hclust(method = "single")

survey_single$labels <- survey$survey_id
```


### Ward

```{r}
# Using ward
survey_ward <- recipe(~., data = survey_mini) %>%
  update_role(survey_id, new_role = "ID") %>% 
  step_normalize(all_predictors()) %>% 
  prep() %>%
  bake(new_data = NULL) %>% 
  dist() %>% 
  hclust(method = "ward.D2")

survey_ward$labels <- survey$survey_id

glimpse(survey_ward)
```

### Exploratory K-means

I think k means probably won't provide as much value as hclust

```{r}
kclusts <- 
  tibble(k = 1:9) %>% 
  mutate(kclust = map(k, ~ kmeans(km_data %>% select(-survey_id), .x)), 
         tidied = map(kclust, tidy), 
         glanced = map(kclust, glance), 
         augmented = map(kclust, augment, km_data))

clusters <- kclusts %>% unnest(cols = c(tidied))

assignments <- kclusts %>% unnest(cols = c(augmented)) %>% 
  left_join(survey %>% select(fs_score, survey_id), by = "survey_id")

clusterings <- kclusts %>% unnest(cols = c(glanced))


theme_set(theme_light())
ggplot(assignments, aes(x = tot_income, y = fs_score)) +
  geom_point(aes(color = .cluster), alpha = 0.8) + 
  scale_x_log10() + 
  facet_wrap(~ k)

survey %>% {sum(is.na(.$tot_income))}
```

```{r}
kclusts %>% 
  unnest(cols = c(tidied))
```


### K-means

```{r}
# k-means clustering and output
set.seed(123)

km_data <- recipe(~., data = survey_mini) %>% 
  update_role(survey_id, new_role = "ID") %>%
  step_normalize(all_predictors()) %>% 
  prep() %>% 
  bake(new_data = NULL)

km_res <- km_data %>%  
  select(-survey_id) %>% 
  kmeans(10, nstart = 25)


```


### Survey kclust 

```{r}
survey_kclust <- survey_mini %>% 
  cbind(cluster = km_res$cluster) %>% 
  mutate(cluster = recode(cluster, 
                          `1` = "L", `2` = "M", `3` = "N", `4` = "O" ,`5` = "P", 
                          `6` = "Q", `7` = "R", `8` = "S", `9` = "T", `10` = "U")) %>% 
  left_join(survey %>%
              select(survey_id, adm3_pcode, 
                     hhfcs_inv, fies_raw_range, csi_weighted, fs_score), 
            by = "survey_id") %>% 
  left_join(read_csv("./data/pcodes.csv") %>% 
              select(admin3_pcode, state) %>% 
              distinct(), 
              by = c("adm3_pcode" = "admin3_pcode")) %>%
  group_by(cluster) %>% 
  mutate(cluster_count = ifelse(is.na(cluster), 0, 1), 
         cluster_n = sum(cluster_count)) %>% 
  ungroup()
```


```{r}
fviz_cluster(km_survey, data = km_data)
```


### Dendrogram options

```{r}
plot(survey_ward) 
rect.hclust(survey_ward, k = 8)
```


```{r}
survey_ward %>% as.dendrogram() %>% set("branches_k_color", k = 10) %>% 
  plot(main = "Default colors")
```

# Survey_hclust


```{r}
survey_hclust <- tibble(
  label = survey_ward$labels,
  cluster_id = cutree(survey_ward, k = 7)) %>%
  right_join(survey_mini, by = c("label" = "survey_id")) %>% 
  mutate(cluster = case_when(cluster_id ==  1 ~ "L",
                             cluster_id ==  2 ~ "M", 
                             cluster_id ==  3 ~ "N", 
                             cluster_id ==  4 ~ "O", 
                             cluster_id ==  5 ~ "P", 
                             cluster_id ==  6 ~ "Q", 
                             cluster_id ==  7 ~ "R", 
                             cluster_id ==  8 ~ "S",
                             cluster_id ==  9 ~ "T", 
                             cluster_id == 10 ~ "U", 
                             cluster_id == 11 ~ "V")) %>% 
  rename(survey_id = label) %>% 
  left_join(survey %>%
              select(survey_id, adm3_pcode, weight_final, 
                     hhfcs_inv, fs_score, 
                     fies_raw_range, csi_weighted), 
            by = "survey_id") %>% 
  left_join(read_csv("./data/pcodes.csv") %>% 
              select(admin3_pcode, state) %>% 
              distinct(), 
              by = c("adm3_pcode" = "admin3_pcode")) %>%
  mutate(cluster_id = as.factor(cluster_id)) %>% 
  group_by(cluster_id) %>% 
  mutate(cluster_count = ifelse(is.na(cluster_id), 0, 1), 
         cluster_n = sum(cluster_count)) %>% 
  ungroup()




```


```{r}

```


## Plotting the clusters against food insecurity indices 

```{r}
plot_score <- function(tbl) {
  
  tbl %>%
    left_join(survey %>% select(survey_id, weight_final), by = "survey_id") %>% 
    # filter(cluster_n >= 50) %>% 
    ggplot(aes(x = cluster, y = value)) +
    geom_jitter(aes(colour = value, size = hh_size), alpha = .25) +
    geom_boxplot(alpha = .3, lwd = 1.3, 
                 aes(fill = weight_final)) +
    scale_colour_viridis(option = "magma", direction = -1) +
    theme(legend.position = "none")  
    
}

survey_hclust %>% 
  left_join(survey %>% select(survey_id, weight_final), by = "survey_id") %>% 
  group_by(cluster) %>% 
  mutate(weight = sum(weight_final), 
         weight_pc = weight / sum(weight)) %>%
  ungroup() %>% 
  ggplot(aes(x = weight_final, y = fs_score, group = cluster, colour = cluster)) + 
  geom_boxplot() +
  # geom_point() + 
  theme(legend.position = "top") + 
  guides(colour = guide_legend(nrow = 1)) +
  labs(colour = "")
  
survey_clust %>% 
  left_join(survey %>% select(survey_id, weight_final), by = "survey_id") %>% 
  group_by(cluster) %>% 
  mutate(weight = sum(weight_final), 
         weight_pc = weight / sum(weight)) %>%
  ungroup() %>% 
  ggplot(aes(x = weight_final, y = fs_score, group = cluster, colour = cluster)) + 
  # geom_boxplot() +
  geom_point(alpha = .4) + 
  theme(legend.position = "top") + 
  guides(colour = guide_legend(nrow = 1)) + 
  labs(colour = "")


```


```{r fig.height=8}
survey_hclust %>% 
  mutate(value = hhfcs_inv) %>% 
  plot_score() +
  geom_hline(yintercept = 0.7083333, lty = 2, colour = "red", alpha = .5, lwd = 2) + 
  geom_hline(yintercept = (112 - 35) / 112, lty = 2, colour = "darkgoldenrod2", alpha = .5, lwd = 2) + 
  labs(x = "cluster", y = "Food consumption score (re-scaled)",
       title = "Food consumption score (re-scaled)", 
       subtitle = "Red line is the 75th percentile.") +

survey_hclust %>% 
  mutate(value = csi_weighted) %>%
  plot_score() + 
  geom_hline(yintercept = 0.1428571, lty = 2, colour = "red", alpha = .5, lwd = 2) +
  labs(x = "cluster", y = "Coping strategies index  (re-scaled)", 
       title = "Coping strategies index  (re-scaled)", 
       subtitle = "Red line is the 75th percentile.") +

survey_hclust %>% 
  mutate(value = fies_raw_range) %>% 
  plot_score() +
  geom_hline(yintercept = 0.25, lty = 2, colour = "red", alpha = .5, lwd = 2) + 
  labs(x = "cluster", y = "Food insecurity experience scale (re-scaled)", 
       title = "Food insecurity experience scale (re-scaled)", 
       subtitle = "Red line is the 75th percentile.") +

survey_hclust %>% 
  mutate(value = fs_score) %>% 
  plot_score() +
  geom_hline(yintercept = 0.2426224, lty = 2, colour = "red", alpha = .5, lwd = 2) + 
  theme(legend.position = "none") +
  labs(x = "cluster", y = "Food insecurity score  (re-scaled)", 
       title = "Food insecurity score  (re-scaled)", 
       subtitle = "Red line is the 75th percentile.") +
  
  plot_layout(widths = 1) + 
  plot_annotation(title = "Comparison between clusters and food security indices", 
                  subtitle = "Darker colours show higher food insecurity", 
                  caption = "Data source: WFP-FAO survey", 
                  theme = theme(plot.caption = element_text(hjust = .5)))


```





```{r}
survey_clust %>% 
  summarise(upper = quantile(fs_score, probs = .75))
survey_clust %>% 
  summarise(mean = mean(fies_raw_range, na.rm = TRUE), 
            upper = quantile(fies_raw_range, probs = .75))
survey_clust %>% 
  summarise(upper = quantile(csi_weighted, probs = .75), 
            mean = quantile(csi_weighted, probs = .5))

survey_clust %>% 
  summarise(upper = quantile(hhfcs_inv, probs = .75), 
            mean = quantile(hhfcs_inv, probs = .5))

```






```{r fig.height=8}


survey_clust %>% 
  ggplot(aes(x = cluster_id, y = fs_score)) + 
  geom_jitter(aes(colour = fs_score, size = hh_size), alpha = .7) +
  geom_boxplot(alpha = .3, colour = "darkgoldenrod1", lwd = 1.8) +
  scale_colour_viridis(option = "magma")  +
  theme(legend.position = "none") 

survey_clust %>%  select(matches("fs_score"))

survey_clust %>% 
  ggplot(aes(x = cluster_id, y =hhfcs_inv)) + 
  geom_jitter(aes(colour = fcs_borderline_poor, size = hh_size), alpha = .7) +
  geom_boxplot(alpha = .3, colour = "darkgoldenrod1", lwd = 1.8) +
  scale_colour_viridis(option = "magma")  +
  theme(legend.position = "none") 
```

```{r}
survey_clust %>% 
  mutate(value = fs_score) %>% 
  summarise(mean = quantile(value, probs = .5),
            lower = quantile(value, probs = .25),
            upper = quantile(value, probs = .75))
  summarise(percentile = ntile(value, 75))

survey_clust %>%
  summarise(mean = mean(shocks_conflict, na.rm = TRUE))

survey3 %>%  
  filter(hh_debt ==  1) %>% 
  count(hh_debt_borrow_from) %>% 
  mutate(n = n / sum(n))



```


## Boxplot state 

```{r fig.height=8}
survey_clust %>% 
  mutate(wt_pc = weight_final / sum(weight_final)) %>%
  filter(!is.na(state)) %>%
  group_by(state) %>% 
  mutate(median = median(fs_score),
         combined_wt = sum(wt_pc)) %>% 
  ungroup() %>% 
  
  ggplot(aes(x = fct_reorder(state, median), y = median, group = state)) + 
  # geom_jitter(aes(colour = fs_score, size = hh_size), alpha = .3) +
  geom_boxplot(colour = "darkgoldenrod1", lwd = 1.5, 
               alpha = .6, 
               aes(fill = weight_final)) +
  geom_jitter()
  # scale_fill_viridis(option = "mako", direction = -1)  +
  scale_y_log10()

survey_clust %>%  
  mutate(wt_pc = weight_final / sum(weight_final)) %>% 
  filter(!is.na(state) & !is.na(weight_final)) %>% 
  
  group_by(state) %>% 
  mutate(median = median(fs_score), 
         wt_pc_state = sum(wt_pc, na.rm = TRUE)) %>% 
  ungroup() %>% 
  
  ggplot(aes(x = fct_reorder(state, median), y = fs_score)) +
    geom_jitter(aes(colour = wt_pc, size = wt_pc * 100), alpha = 1) +
    geom_boxplot(alpha = .6, colour = "grey20", 
                 aes(lwd = wt_pc_state)) +
    scale_colour_viridis(option = "mako", direction = -1) +
    theme(legend.position = "none")  + 
  geom_hline(yintercept = 0.2426743, lwd = 2, colour = "red", lty = 2, alpha = .5)

survey %>% ggplot(aes(x = fs_score)) + geom_histogram()

```


If you work with those in Cluster 4, that 
If you work in Cluster 5, with conflict, the variables you should consider are 


## Reference table



```{r fig.height=8}
  
js <- c(
  "function(settings){",
  "  var datatable = settings.oInstance.api();",
  "  var table = datatable.table().node();",
  "  var caption = 'fs_score, fcs, fies & csi rescaled between 0 (best) and 1 (worst); other columns show percentages of group populations.'",
  "  $(table).append('<caption style=\"caption-side: bottom\">' + caption + '</caption>');",
  "}"
)

survey_kclust %>% 
  left_join(survey %>% select(survey_id, weight_final)) %>% 
  # filter(cluster_id !=  "O") %>%
  filter(hh_size != 0) %>% 
  # mutate(cluster = case_when(cluster == "O" ~ "S", TRUE ~ paste0(cluster))) %>% 
  group_by(cluster) %>% 
  summarise(sample = n(),
            
            fs_score = mean(fs_score, na.rm = TRUE),
            fies = mean(fies_raw_range, na.rm = TRUE),
            csi = mean(csi_weighted, na.rm = TRUE), 
            fcs = mean(hhfcs_inv, na.rm = TRUE),
            weighted = sum(weight_final, na.rm = TRUE), 
            rural = mean(rural, na.rm = TRUE), 
            income_reduced = mean(income_reduced, na.rm = TRUE),
            debt_more = mean(hh_debt_more, na.rm = TRUE), 
            conflict = mean(shocks_conflict), 
            lost_work = mean(shocks_lostwork), 
            food_prices = mean(shocks_foodprices), 
            stable_non_ag = mean(ims_stable_non_ag),
            farmer = mean(ims_farmer), 
            stable_ag = mean(ims_stable_ag), 
            casual_ag = mean(ims_casual_ag), 
            casual_non_ag = mean(ims_casual_non_ag), 
            public_em = mean(ims_public_em), 
            no_income = mean(ims_no_income),
            
            children_0_4 = mean(children_0_4, na.rm = TRUE), 
            edu_sec = mean((edu_secondary + edu_higher), na.rm = TRUE),
            tot_income = sum(tot_income, na.rm = TRUE),
            pop = sum(hh_size, na.rm = TRUE)) %>%  
  mutate_at(vars(rural:children_0_4), ~ round(.x * 100, digits = 2)) %>% 
  mutate_at(vars(fs_score, fies, csi, fcs), ~ range_wna(.x)) %>%
  mutate_at(vars(sample), ~ round((.x)/ sum(.x) * 100, digits = 2)) %>% 
  mutate_at(vars(weighted), ~ round((.x)/ sum(.x) * 100, digits = 2)) %>% 
  mutate(income_pc = round(tot_income / pop, digits = 0)) %>% 
  select(-tot_income, -pop, -sample) %>% 
  relocate(income_pc, .after = rural) %>% 
  arrange(desc(fs_score)) %>% pander()
  # filter(sample >= 1) %>% 
  


  datatable(filter = list(position = "top", clear = FALSE),
            options = list(pageLength = 11, scrollX = TRUE,
              initComplete = JS(js),#This will avoid looping of the caption when there is pagination
              headerCallback = DT::JS("function(thead) {", 
                          "  $(thead).css('font-size', '.8em');",
                          "}")),
  caption = htmltools::tags$caption(style = "caption-side: top; color: black; 
                                              text-align: center; font-size: 130%;",
                                              "Possible component of a beneficiary profile"), 
  ) %>%  
  formatRound(c("fs_score", "fies", "csi", "fcs", "edu_secondary"), digits = 3) %>%
  formatStyle(0, target = "row", lineHeight = "80%", fontSize = "80%") 

survey_clust %>% glimpse()
  mutate(na_tot_income = ifelse(tot_income == 0, 1, 0), 
         na_hh_size = ifelse(hh_size == 0, 1, 0)) %>% 
  count(na_hh_size, na_tot_income)


```


### Reference - Hclust

```{r}
survey_mini %>% 
  left_join(survey %>% select(survey_id, weight_final, 
                              fies_raw_range, csi_weighted, hhfcs_inv, fs_score), by = "survey_id") %>%
  mutate(priority = ifelse(fs_score >= quantile(fs_score, probs = .75), 
                           "priority", "not_priority")) %>%
  filter(hh_size != 0) %>% 
  select(matches("fies_|fcs_|cs_"), priority) %>% 
  group_by(priority) %>% 
  summarise_all(mean) %>% 
  pivot_longer(cols = -c(priority))  
  
survey_hclust %>% 
  select(matches("fies_|fcs_|cs_"), fs_score, cluster) %>% 
  group_by(cluster) %>% 
  summarise_all(mean) %>%
  left_join(survey_hclust %>% 
          group_by(cluster) %>% 
          summarise(weighted = sum(weight_final)) %>% 
          ungroup() %>% 
          mutate(weighted = round(weighted / sum(weighted) * 100, digits = 2)), 
          by = "cluster") %>% 
  arrange(desc(fs_score))
```


## Food Security indicators

```{r}
survey_mini %>% 
  select(matches("fies|fcs_|cs_"), shocks_conflict) %>% 
  select(-fcs_borderline_poor, -matches("fcs")) %>% 
  lm(shocks_conflict ~ ., data = ., family = "quasibinomial") %>% 
  tidy(conf.int = TRUE) %>% 
  # filter(p.value <= .05) %>% 
  filter(term != "(Intercept)") %>% 
  mutate(term = fct_reorder(term, estimate)) %>%  
  ggplot(aes(x = estimate, y = term, colour = estimate)) + 
  geom_vline(xintercept = 0, lty = 2, colour = "red") + 
  geom_point() + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) + 
  scale_colour_viridis(option = "turbo") + 
  theme(legend.position = "none", 
        axis.text.y = element_text(size = 8.5), 
        axis.title.x = element_text(size = 7, face = "bold"), 
        plot.title = element_text(size = 9))
  
  summary()
```

### Priority non-priority

```{r}
survey_mini %>% 
  left_join(survey %>% select(survey_id, weight_final, 
                              fies_raw_range, csi_weighted, hhfcs_inv, fs_score), by = "survey_id") %>%
  mutate(priority = ifelse(fs_score >= quantile(fs_score, probs = .75), 
                           "priority", "not_priority")) %>%
  filter(hh_size != 0) %>% 
  select(matches("fies_|fcs_|cs_"), priority) %>% 
  group_by(priority) %>% 
  summarise_all(mean) %>% 
  pivot_longer(cols = -c(priority)) %>%  
  filter(name %out% c("hhfcs_inv", "fs_score", "csi_weighted", "fies_raw_range", "fcs_borderline_poor")) %>% 
  ggplot(aes(y = value, x = name)) + 
  geom_col(position = position_dodge(), aes(fill = priority), width = .5) + 
  scale_fill_brewer(palette = "Dark2") + 
  scale_y_continuous(labels = percent_format(accuracy = 1), breaks = seq(0, 1, .1)) + 
  labs(x = "", y = "Percent of group", 
       title = "Food security indicators -- priority and non-priority group") +  
  coord_flip() + 
  theme(plot.background = element_rect(colour = "white"))
  
ggsave(filename = "./misc/priority_non_priority_round3.png", dpi = 300, height = 7, width = 11, units = "in")
  
```

### k-means for food security index component indicators

```{r}
# k-means clustering and output
set.seed(123)

km_data_fs <- recipe(~., data = survey_mini %>% 
                    select(matches("fies|fcs_|cs_"), survey_id)) %>% 
  update_role(survey_id, new_role = "ID") %>%
  step_normalize(all_predictors()) %>% 
  prep() %>% 
  bake(new_data = NULL)

km_res_fs <- km_data_fs %>%  
  select(-survey_id) %>% 
  kmeans(7, nstart = 25)


```

```{r}
mini_fs <- survey_mini %>% 
  cbind(cluster = km_res_fs$cluster) %>%  
  left_join(survey %>% select(fs_score, survey_id), by = "survey_id") %>% 
  group_by(cluster) %>% 
  mutate(cluster_count = ifelse(is.na(cluster), 0, 1), 
         cluster_n = sum(cluster_count)) %>% 
  ungroup()

mini_fs %>% 
  select(-survey_id) %>% 
  group_by(cluster) %>% 
  summarise_all(mean) %>% 
  select(-matches("fies|fcs_|cs_")) %>% 
  arrange(desc(fs_score))


```

```{r fig.height=6}
survey_mini %>% 
  left_join(survey %>% select(survey_id, weight_final, 
                              fies_raw_range, csi_weighted, hhfcs_inv, fs_score), by = "survey_id") %>%
  mutate(priority = ifelse(fs_score >= quantile(fs_score, probs = .75), 
                           "priority", "not_priority")) %>%
  filter(hh_size != 0) %>% 
  select(-matches("fcs_|cs_|fies_|cluster|state|adm3|weight_final")) %>% 
  select(-survey_id) %>% 
  group_by(priority) %>% 
  summarise_all(mean) %>% 
  pivot_longer(cols = -c(priority)) %>% 
  pivot_wider(names_from = priority, values_from = value) %>% 
  arrange(desc(priority)) %>% 
  mutate(percent_diff = (priority - not_priority) / not_priority) %>% 
  mutate_at(vars(not_priority, priority, percent_diff), ~ round(.x * 100, digits = 2)) %>% 
  mutate(not_priority = ifelse(name %in% c("tot_income", "hh_size",
                                           "fs_score", "hhfcs_inv", "csi_weighted", "fies_raw_range"),
                               round(not_priority / 100, digits = 2), not_priority), 
         priority = ifelse(name %in% c("tot_income", "hh_size", 
                                       "fs_score", "hhfcs_inv", "csi_weighted", "fies_raw_range"),
                           round(priority / 100, digits = 2), priority)) %>%  
  arrange(desc(percent_diff)) %>% 
  filter(name %out% c("csi_weighted", "fies_raw_range", "hhfcs_inv", "fs_score", "tot_income")) %>% 
  mutate(name = fct_reorder(name, percent_diff)) %>% 
  ggplot(aes(x = priority, y = name)) + 
  geom_col(aes(fill = percent_diff)) + 
  geom_text(aes(label = percent_diff), hjust = 0) + 
  scale_fill_viridis(option = "inferno", direction = -1) + 
  scale_x_continuous(breaks = seq(0, 60, by = 10)) +
  labs(x = "% of priority group", y = "", fill = "%diff", 
       title = "Indicators most associated with food insecurity", 
       subtitle = "Darker colours show indicators most associated with food insecurity", 
       caption = "Data source: FAO-WFP food security survey round 3") + 
  theme(plot.caption = element_text(hjust = .5), 
        plot.background = element_rect(colour = "white"))

ggsave(filename = "./misc/food_insecurity_round3.png", dpi = 300, height = 7, width = 11, units = "in")
  
```


```{r}
survey_mini %>% 
  count(covid_marketclosed, no_accessmarket, shocks_accessmarket)
```

## Trees again 

```{r}
tree4 <- survey %>% 
  rpart(priority ~  shocks_lostwork + shocks_sicknessdeath + shocks_foodprices + shocks_conflict + shocks_cantworkbusiness +
          shocks_naturalhazard + shocks_accessmarket + shocks_pricesother + shocks_other + rural + not_improved_sanitation,
        data = .,  weights = combined_wt , cp = 0.01)

tree6 <- survey %>% 
  mutate(children_0_4 = ifelse(children_0_4 > 0, 1, 0)) %>% 
  rpart(priority ~ children_0_4 + hoh_female + hoh_education + hoh_age, data = ., weights = combined_wt, cp = .0088)

survey <- survey %>% 
  mutate(rule4 = row.names(tree4$frame)[tree4$where]) %>% 
  left_join(rpart.rules.table(tree4) %>% 
              filter(Leaf == TRUE) %>% 
              rename(rule4 = Rule) %>% 
              group_by(rule4) %>% 
              summarise(subrules4 = paste(Subrule, collapse = ",")), by = "rule4") %>% 
  mutate(rule6 = row.names(tree6$frame)[tree6$where]) %>% 
  left_join(rpart.rules.table(tree6) %>% 
              filter(Leaf == TRUE) %>% 
              rename(rule6 = Rule) %>% 
              group_by(rule6) %>% 
              summarise(subrules6 = paste(Subrule, collapse = ",")), by = "rule6")

tree7 <- survey_mini %>% 
  left_join(survey %>% select(survey_id,
                              fies_raw_range, csi_weighted, hhfcs_inv, fs_score), by = "survey_id") %>%
  mutate(priority = ifelse(fs_score >= quantile(fs_score, probs = .75), 
                           1, 0)) %>%
  filter(hh_size != 0) %>% 
  select(-matches("fcs_|cs_|fies_|cluster|state|adm3|fs_score|csi|survey_id|tot_income")) %>% 
  rpart(priority ~ ., data = ., cp = .005)

tree8 <- survey_mini %>% 
  left_join(survey %>% select(survey_id, fs_score, csi_weighted, hhfcs_inv, fies_raw_range), 
            by = "survey_id") %>% 
  mutate(priority = case_when(hhfcs_inv >= quantile(hhfcs_inv, probs = 0.75) & 
                                 fies_raw_range >= quantile(fies_raw_range, probs = 0.75) ~ 1, 
                               hhfcs_inv >= quantile(hhfcs_inv, probs = 0.75) & 
                                 csi_weighted >= quantile(csi_weighted, probs = 0.75) ~ 1,
                              fies_raw_range >= quantile(fies_raw_range, probs = 0.75) & 
                                 csi_weighted >= quantile(csi_weighted, probs = 0.75) ~ 1, 
                               TRUE ~ 0)) %>%  
  select(matches("ims|shocks|edu_"), priority, 
         hh_debt_more, no_accessmarket, income_reduced, rural, children_0_4) %>% 
  rpart(priority ~ ., data = .)

plotcp(tree8)

fancyRpartPlot(tree8, digits = -3, palettes = "Blues", type = 2, sub = "", 
               main = "Test tree")

rpart.plot(tree8, fallen.leaves = TRUE)
```

```{r}
survey_mini %>% 
  select(-survey_id, -tot_income) %>% 
  lm(hh_debt_more ~ ., data = .) %>% 
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)" & p.value <= .05) %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
  ggplot(aes(x = estimate, y = term)) + 
  geom_vline(xintercept = 0, lty = 2, colour = "red") + 
  geom_point() + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) +
  
survey_mini %>% 
  select(-survey_id, -tot_income) %>% 
  lm(no_accessmarket ~ ., data = .) %>% 
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)" & p.value <= .05) %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
  ggplot(aes(x = estimate, y = term)) + 
  geom_vline(xintercept = 0, lty = 2, colour = "red") + 
  geom_point() + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) +

survey_mini %>% 
  select(-survey_id, -tot_income) %>% 
  lm(shocks_lostwork ~ ., data = .) %>% 
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)" & p.value <= .05) %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
  ggplot(aes(x = estimate, y = term)) + 
  geom_vline(xintercept = 0, lty = 2, colour = "red") + 
  geom_point() + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) +

survey_mini %>% 
  select(-matches("ims")) %>% 
  left_join(survey_mini %>% select(ims_casual_non_ag, survey_id), 
            by = "survey_id") %>% 
  select(-survey_id, -tot_income) %>% 
  lm(ims_casual_non_ag ~ ., data = .) %>% 
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)" & p.value <= .05) %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
  ggplot(aes(x = estimate, y = term)) + 
  geom_vline(xintercept = 0, lty = 2, colour = "red") + 
  geom_point() + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) 

```


```{r}
survey_clust %>% 
  left_join(survey %>% select(survey_id, weight_final)) %>% 
  # filter(cluster_id !=  "O") %>%
  filter(hh_size != 0) %>% 
  # mutate(cluster = case_when(cluster == "O" ~ "S", TRUE ~ paste0(cluster))) %>% 
  group_by(cluster) %>% 
  summarise(sample = n(),         
            fs_score = mean(fs_score, na.rm = TRUE),
            fies = mean(fies_raw_range, na.rm = TRUE),
            csi = mean(csi_weighted, na.rm = TRUE), 
            fcs = mean(hhfcs_inv, na.rm = TRUE),
            weighted = sum(weight_final, na.rm = TRUE), 
            rural = mean(rural, na.rm = TRUE), 
            income_reduced = mean(income_reduced, na.rm = TRUE),
            debt_more = mean(hh_debt_more, na.rm = TRUE), 
            conflict = mean(shocks_conflict), 
            lost_work = mean(shocks_lostwork), 
            food_prices = mean(shocks_foodprices), 
            stable_non_ag = mean(stable_non_ag),
            farmer = mean(farmer), 
            prof_self_em = mean(prof_self_em), 
            stable_ag = mean(stable_ag), 
            casual_ag = mean(casual_ag), 
            casual_non_ag = mean(casual_non_ag), 
            public_em = mean(public_em), 
            no_income = mean(no_income),
            income_other = mean(other), 
            children_0_4 = mean(children_0_4, na.rm = TRUE), 
            edu_secondary = mean((edu_secondary + edu_higher), na.rm = TRUE),
            tot_income = sum(tot_income, na.rm = TRUE),
            pop = sum(hh_size, na.rm = TRUE)) %>%  
  mutate_at(vars(rural:children_0_4), ~ round(.x * 100, digits = 2)) %>% 
  mutate_at(vars(fs_score, fies, csi, fcs), ~ range_wna(.x)) %>%
  mutate_at(vars(sample), ~ round((.x)/ sum(.x) * 100, digits = 2)) %>% 
  mutate_at(vars(weighted), ~ round((.x)/ sum(.x) * 100, digits = 2)) %>% 
  mutate(income_pc = round(tot_income / pop, digits = 0)) %>% 
  select(-tot_income, -pop, -sample) %>% 
  relocate(income_pc, .after = rural) %>% 
  arrange(desc(fs_score)) 
  
```

L are the most  in need 

```{r}
survey_clust %>%
  filter(cluster == "R") %>% 
  select(matches("cs_")) %>% 
  pivot_longer(cols = everything(), 
               names_to = "var", 
               values_to = "value") %>% 
  group_by(var) %>% 
  summarise_all(mean)
```


```{r}

survey %>% 
  left_join(tribble(~income_main, ~income_main_source, ~sub_groups,
        1, "Farmer / Production and sale", "Farmer / Production and sale of staple crops",
        2, "Farmer / Production and sale", "Farmer / Production and sale of vegetable or fruit", 
        3, "Farmer / Production and sale", "Farmer / Production and sale of cashcrops",
        4, "Farmer / Production and sale", "Farmer / Production and sale of livestock and livestock products",
        5, "Farmer / Production and sale", "Farmer / Production and sale of fish",
        6, "Collection and sale of forestry or bush products", "",
        7, "Informal agricultural trade EXCLUDING producers", "",
        8, "Formal agricultural trade EXCLUDING producers", "",
        9, "Daily wage on farms and other casual employment in agricultural sector", "",
        10, "Stable employment in agricultural sector", "",
        11, "Non-agricultural self-employed or liberal profession / doctor / architect / lawyer / including restaurant", "",
        12, "Off-farm daily wages and other non-agricultural casual employment", "",
        13, "Stable employment in non-agricultural sector",  "",
        14, "Public employment", "",
        15, "Income not derived from work / Charity", "",
        16, "Income not derived from work / Welfare transfer / pension / humanitarian aid", "",
        17, "Income not derived from work / Remittances", "",
        18, "Income not derived from work / Income from other rents", "",
        19, "No income source in the last 3 months and used exclusively savings", "",
        20, "No income source in the last 3 months and used exclusively debt", "",
        21, "REFUSED", ""), 
        by = "income_main") %>% 
  count(income_main_source, sort = TRUE) %>% 
  mutate(pc = n / sum(n))
  select(survey_id, income_main_source) %>%
  mutate(count = ifelse(!is.na(income_main_source), 1, 0)) %>%
  pivot_wider(names_from = income_main_source, values_from = count, values_fill = 0) %>% 
  janitor::clean_names()
  count(income_main_source, sort = TRUE) %>% 
  mutate(pc = n / sum(n))
 

 

```


## State

```{r}
glimpse(survey)

survey %>% 
  group_by(adm1_name_en) %>%  
  summarise(conflict = mean(shocks_conflict), 
            count = n(), 
            weight = sum(weight_final)) %>% 
  mutate(pc_weight = weight / sum(weight)) %>% 
  arrange(desc(conflict))

survey_mini %>%  
  select(-su)
  lm(shocks_conflict ~ .,  data = .) %>% 
  tidy()
```


## Alternate clustering

### Debt

```{r}
survey_mini %>% 
  group_by(hh_debt) %>% 
  
  summarise_all(mean)
  
survey_mini %>% count(hh_debt)

survey_mini %>%
  select(hh_debt_more, matches("fies|cs_|fcs_")) %>% 
  lm(hh_debt_more ~ ., data = ., family = "binomial") %>% 
  plot_coef()  

survey_mini %>% 
  select(hh_debt, matches("fies|cs_|fcs_")) %>% 
  lm(hh_debt ~ ., data = ., family = "binomial") %>% 
  plot_coef()

survey_mini %>% 
  mutate(stress_borrowed_money = cs_stress_borrowed_money) %>% 
  select(-matches("fies|cs_|fcs_"), -matches("from_|why_")) %>% 
  lm(stress_borrowed_money ~ ., data = .) %>% 
  plot_coef()

  nest(-hh_debt) %>% 
  map(data, ~ lm(fs_score))
  
```


### Income Source
```{r fig.height=8}

survey_mini %>% 
  select(matches("ims"), survey_id) %>% 
  pivot_longer(cols = -survey_id, names_to = "income_main_source", values_to = "value") %>%  
  filter(value == 1) %>% 
  left_join(survey %>% 
              select(fs_score, survey_id), by = "survey_id") %>% 
  lm(fs_score ~ income_main_source, data = .) %>% 
  tidy(conf.int = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    mutate(term = str_replace(term, "income_main_sourceims_", "")) %>%  
  left_join(
    
    survey %>%
      select(matches("ims"), survey_id, weight_final) %>%
      pivot_longer(cols = -c(survey_id, weight_final), names_to = "term", values_to = "value") %>%  
      mutate(term = str_replace(term, "ims_", "")) %>%  
      mutate(value = value * weight_final) %>% 
      group_by(term) %>% 
      summarise_at("value", sum)
    , 
    by = "term"
    
            ) %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
    ggplot(aes(x = estimate, y = term, colour = estimate)) + 
    geom_vline(xintercept = 0, lty = 2, colour = "red") + 
    geom_point(aes(size = value)) + 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2, width = 1.5) + 
    scale_colour_viridis(option = "turbo") + 
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 8.5), 
          axis.title.x = element_text(size = 7, face = "bold"), 
          plot.title = element_text(size = 9))


```


```{r}
survey_mini %>% 
  select(matches("ims"), survey_id) %>% 
  pivot_longer(cols = -survey_id, names_to = "income_main_source", values_to = "value") %>%  
  filter(value == 1) %>% 
  left_join(survey %>% select(fs_score, weight_final, )) 
  
```

```{r}
survey %>% count(income_main)
```


```{r}
survey_mini %>% 
  left_join(survey %>% select(fs_score, survey_id), by = "survey_id") %>%  
  select(fs_score, matches("ims")) %>% 
  lm(fs_score ~ ., data = .) %>% 
  tidy()

survey %>%
  select(fs_score, income_main)
```



```{r}
survey_mini %>% count(hh_debt, hh_debt_more)
```


### Shocks 


```{r}

survey %>%  
  summarise_at(c("shocks_conflict",
    "shocks_lostwork",
    "shocks_naturalhazard", 
    "shocks_accessmarket", 
    "shocks_foodprices",
    "shocks_cantworkbusiness"), sum)
```


```{r}
survey %>% 
  filter(hh_debt_more == 1) %>% 
  left_join(tribble(~hh_debt_borrow_from, ~debt_borrow_from_text,
                    1, "x66_Relatives",
                    2, "x66_Relatives living outside the country",
                    3, "x66_Traders/shopkeepers",
                    4, "x66_Bank/Credit institution/Government/Micro-credit project",
                    5, "x66_Money lender",
                    6, "x66_Landlord [more than 1 month behind in rent]",
                    7, "x66_Informal savings group",
                    8, "x66_Employer",
                    9, "x66_Other")) %>% 
  mutate(count = ifelse(!is.na(debt_borrow_from_text), 1, 0)) %>% 
  pivot_wider(names_from = debt_borrow_from_text, values_from = count, values_fill = 0) %>% 
  clean_names() %>%
  select(matches("x"))
  
survey %>% 
  count(hh_debt_borrow_from, sort = TRUE)

survey %>% 
  count(hh_debt_borrow_why, sort = TRUE)

 

```

```{r}
survey %>% 
  lm(fs_score ~ fcs_pr, data = .) %>% 
  summary()
```



```{r}
survey_clust %>% 
  ggplot(aes(x = conflict, y = (income_pc + 1) * ))
```

 M and Q are just food secure. 
 
 S working and food insecure 
 Multidimensional
 heavily indebted 
 
```{r}
survey %>% glimpse()
```
 
 
 Income 
 
 Two large groups -- ones whose main income is stable, non-agricultural work and those who do not. 
 
 Groups **M**, **P**, and **L**, together `r 42.06 + 4.73 + 5.32`% of the sample population. They have the highest incomes per capita 
 
 
### Farmers
 
Needs and targets for crops 

Needs and targets for livelihood activities

Depth of assistance -- it really gives the wrong impression 

Three months at 2,100 kcal/day 

## conflict


```{r}
survey_mini %>% 
  select(-survey_id) %>% 
  lm(shocks_conflict ~ ., data = .) %>%
  tidy() %>% 
  filter(p.value < .05) %>% 
  arrange(desc(estimate))
```

```{r}

survey %>%
  select(shocks_conflict, hoh_education, fs_score) %>%
  group_by(hoh_education) %>% 
  do(tidy(lm(data = ., formula = fs_score ~ shocks_conflict), conf.int = TRUE)) %>% 
  filter(term != "(Intercept)" & !is.na(hoh_education)) %>%
  filter(p.value < .05) %>% 
  ungroup() %>% 
  mutate(hoh_education = fct_reorder(hoh_education, estimate)) %>% 
  ggplot(aes(x = estimate, y = hoh_education, colour = estimate)) + 
    geom_vline(xintercept = 0, lty = 2, colour = "red") + 
    geom_point(size = 2) + 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) + 
    scale_colour_viridis(option = "turbo") + 
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 8.5), 
          axis.title.x = element_text(size = 7, face = "bold"), 
          plot.title = element_text(size = 9), 
          plot.background = element_rect(colour = "white")) + 
  labs(y = "Education level, head of household") + 

survey %>%
  select(shocks_conflict, income_main_text, fs_score) %>%
  group_by(income_main_text) %>% 
  do(tidy(lm(data = ., formula = fs_score ~ shocks_conflict), conf.int = TRUE)) %>% 
  filter(term != "(Intercept)" & !is.na(income_main_text)) %>%
  filter(p.value < .05) %>% 
  ungroup() %>% 
  mutate(income_main_text = str_remove(income_main_text, "ims_"), 
         income_main_text = fct_reorder(income_main_text, estimate)) %>% 
  ggplot(aes(x = estimate, y = income_main_text, colour = estimate)) + 
    geom_vline(xintercept = 0, lty = 2, colour = "red") + 
    geom_point(size = 2) + 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .2) + 
    scale_colour_viridis(option = "turbo") + 
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 8.5), 
          axis.title.x = element_text(size = 7, face = "bold"), 
          plot.title = element_text(size = 9), 
          plot.background = element_rect(colour = "white")) + 
  labs(y = "Main income source") + 
  
  
  plot_annotation(title = "Impact of conflict on food insecurity ", 
                  subtitle = "Redder colours indicate higher correlations with food insecurity", 
                  caption = "Data source: WFP-FAO survey; only showing indicators with p-value < 0.05", 
                  theme = theme(plot.caption = element_text(hjust = .5)))
  
ggsave(filename = "./misc/conflict_estimates.png", dpi = 300, height = 7, width = 11, units = "in")


```
 
 


```{r}
survey_mini %>% 
  select(-edu_religious, -edu_none) %>% 
  cor() %>% 
  corrplot(tl.cex = 1.5)
```


Can these groups be linked to the township prioritisation groups? 
It has been proven in other contexts that education is a strong predictor of wealth and also of adaptability to shocks and stresses



# Clustering 

```{r}

set.seed(123)

kclusts 
  
  survey_mini %>%
    left_join(survey %>%  select(final_weight, survey_id), by = "survey_id") %>%
    mutate_all(.x * final_weight) %>% 
    select(-matches("fies_|fcs_|cs_|survey_id|final_weight"))
  
    summarise_all(mean) %>%  pivot_longer(cols = everything()) %>% arrange(desc(value))
  tibble(k = 1:29) %>%
  mutate(kclust = map(k, ~kmeans(points, .x)), 
         tidied = map(kclust, tidy), 
         glanced = map(kclust, glance), 
         augmented = map(kclust, augment, points))

survey_mini %>% 
  ggplot(aes(x = fcs_pr, y = income_reduced)) + 
  geom_jitter()


survey %>% glimpse()

survey_mini %>% 
  select(-matches("fies_|fcs_|cs_|survey_id")) %>% 
  glimpse()
```

# Needs

```{r}
survey %>% 
  select(matches("need_")) %>%
  select(-matches("need_received")) %>% 
  summarise_all(mean, na.rm = TRUE) %>%
  pivot_longer(cols = everything(), names_to = "name", values_to = "value_r3") %>% 
  left_join(survey2 %>%  
              select(matches("need_")) %>%  
              select(-matches("need_received")) %>%
              summarise_all(mean, na.rm = TRUE) %>% 
              pivot_longer(cols = everything(), names_to = "name", values_to = "value_r2")) %>% 
  arrange(desc(value_r3)) %>% 
  mutate(name = str_remove(name, "need_"))
  
sum(survey$weight_final)

survey %>%
  {sum(.$need, na.rm = TRUE)}

survey %>% 
  filter(need == 0) %>% 
  {sum(.$weight_final)}

survey %>% nrow()

survey %>% {sum(.$weight_final, na.rm = TRUE)}

survey %>% 
  mutate(need = as.factor(need)) %>% 
  
  ggplot(aes(x = adm_name, y = weight_final)) + 
  geom_col(aes(fill = need), position = position_dodge())


```

### Needs Plot 

```{r}
survey %>% 
  group_by(state = adm_name, need) %>% 
  summarise(weight = sum(weight_final)) %>% 
  mutate(need = recode(need, 
                       `1` = "yes", 
                       `0` = "no"), 
         need = fct_rev(need)) %>% 
  ggplot(aes(x = state, y = weight, fill = need)) + 
  geom_col(position = position_dodge())
```

```{r}
survey %>% 
  mutate_at(vars(contains("need_")), ~ .x * weight_final) %>% 
  select(contains("need_")) %>% 
  select(-contains("received")) %>% 
  replace(is.na(.), 0) %>%
  summarise_all(mean) %>%
  pivot_longer(cols = everything()) %>% 
  filter(value >= .01) %>% 
  mutate(name = str_remove(name, "need_"), 
         name = fct_reorder(name, value)) %>% 
  ggplot(aes(x = value, y = name)) + 
  geom_col() + 
  geom_text(aes(label = percent(value, accuracy = .1)), hjust = -.1) + 
  scale_x_continuous(labels = percent) +
  labs(x = "% of population", y = "Need", 
       title = "Most common needs", 
       caption = "Data source: FAO-WFP food security survey round 3") + 
  theme(plot.background = element_rect(colour = "white"))

ggsave(filename = "./misc/most_common_needs.png", dpi = 300, height = 7, width = 11, units = "in")

```


### Comparison of needs with achieved 

```{r}
fsc <- read_csv("./data/fsc_q1_2022.csv")

fsc %>% 
  filter(!is.na(delivery_modality)) %>% 
  group_by(delivery_modality) %>% 
  summarise_at("reached_beneficiaries", sum) %>% 
  mutate(pc = reached_beneficiaries / sum(reached_beneficiaries))
  
```


```{r}
survey2 %>% 
  select(matches("need_")) %>% 
  select(-matches("received")) %>% 
  
  summarise_all(mean, na.rm = TRUE) %>% 
  pivot_longer(cols = everything(), names_to = "name", values_to = "round2") %>% 
  full_join(survey %>% 
              select(matches("need")) %>% 
              select(-matches("received")) %>% 
              summarise_all(mean, na.rm = TRUE) %>% 
              pivot_longer(cols = everything(), names_to = "name", values_to = "round3"), by = "name") %>% 
  filter(!str_detect(name, "needs")) %>% 
  # filter(round2 >= 0.01 | round3 >= 0.01) %>%
  mutate_at(vars(round2, round3), ~ 
              round(.x, digits = 3)) %>% arrange(desc(round3))
  mutate(name = str_remove(name,  "need_")) %>% 
  arrange(desc(round3))
  
  mutate(name = recode(name, 
                       "need_medicalservicessupply" = "medicalsupplyhealth", 
                       "need_educationassistance" = "need_educationsupport", 
                       "need_jobopportunity" = "need_job"))
```

